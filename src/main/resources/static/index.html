<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Transfer</title>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #fafaf8;
            --white: #ffffff;
            --ink: #1a1a18;
            --ink-2: #4a4a45;
            --ink-3: #9a9a92;
            --ink-4: #d4d4cc;
            --green: #1a7a4a;
            --green-bg: #f0f7f3;
            --red: #c0392b;
            --red-bg: #fdf3f2;
            --blue: #1a4a8a;
            --blue-bg: #f0f4fb;
            --border: #e8e8e2;
            --serif: 'Instrument Serif', Georgia, serif;
            --sans: 'Inter', system-ui, sans-serif;
            --radius: 12px;
        }

        html { font-size: 16px; }

        body {
            background: var(--bg);
            color: var(--ink);
            font-family: var(--sans);
            font-weight: 400;
            line-height: 1.5;
            min-height: 100vh;
        }

        header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 0 48px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-serif { font-family: var(--serif); font-size: 22px; color: var(--ink); letter-spacing: -0.3px; }
        .logo-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--green); margin-left: 3px; vertical-align: middle; }

        .api-badge { display: flex; align-items: center; gap: 7px; font-size: 12px; color: var(--ink-3); }
        .api-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--ink-4); transition: background 0.4s; }
        .api-dot.live { background: #2ecc71; box-shadow: 0 0 0 3px #2ecc7120; }
        .api-dot.dead { background: var(--red); }

        .layout { display: grid; grid-template-columns: 220px 1fr; min-height: calc(100vh - 60px); }

        aside {
            background: var(--white);
            border-right: 1px solid var(--border);
            padding: 40px 0;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .nav-section { padding: 0 24px; margin-bottom: 32px; }
        .nav-label { font-size: 10px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--ink-3); margin-bottom: 8px; padding: 0 8px; }

        .nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 12px; border-radius: 8px; cursor: pointer;
            font-size: 14px; color: var(--ink-2); font-weight: 400;
            transition: all 0.15s; border: none; background: none;
            width: 100%; text-align: left; margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--bg); color: var(--ink); }
        .nav-item.active { background: var(--ink); color: var(--white); font-weight: 500; }
        .nav-icon { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 13px; opacity: 0.7; }
        .nav-item.active .nav-icon { opacity: 1; }

        aside hr { border: none; border-top: 1px solid var(--border); margin: 0 24px 24px; }

        .sidebar-stat { padding: 0 32px; margin-bottom: 8px; }
        .sidebar-stat-label { font-size: 11px; color: var(--ink-3); margin-bottom: 2px; }
        .sidebar-stat-value { font-family: var(--serif); font-size: 22px; color: var(--ink); letter-spacing: -0.5px; }

        main { padding: 48px; max-width: 820px; }

        .panel { display: none; animation: fadeIn 0.2s ease; }
        .panel.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page-header { margin-bottom: 36px; }
        .page-title { font-family: var(--serif); font-size: 36px; font-weight: 400; letter-spacing: -0.5px; line-height: 1.1; margin-bottom: 8px; }
        .page-title em { font-style: italic; color: var(--green); }
        .page-sub { font-size: 14px; color: var(--ink-3); }

        .card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; margin-bottom: 16px; }
        .card-title { font-size: 11px; font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; color: var(--ink-3); margin-bottom: 20px; }

        .field { margin-bottom: 14px; }
        .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        label { display: block; font-size: 12px; font-weight: 500; color: var(--ink-2); margin-bottom: 6px; }

        input, select {
            width: 100%; padding: 10px 14px;
            background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; color: var(--ink);
            font-family: var(--sans); font-size: 14px; font-weight: 400;
            outline: none; transition: border-color 0.15s, box-shadow 0.15s;
            appearance: none;
        }
        input:focus, select:focus { border-color: var(--ink-2); background: var(--white); box-shadow: 0 0 0 3px rgba(26,26,24,0.06); }
        input::placeholder { color: var(--ink-4); }
        input[readonly] { color: var(--ink-3); cursor: default; }
        select option { background: var(--white); }

        .btn-row { display: flex; gap: 8px; margin-top: 6px; }

        .btn {
            padding: 10px 20px; border-radius: 8px; border: none;
            font-family: var(--sans); font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.15s; letter-spacing: 0.1px;
        }
        .btn-primary { background: var(--ink); color: var(--white); }
        .btn-primary:hover { background: #2d2d2a; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary:active { transform: translateY(0); }
        .btn-ghost { background: transparent; color: var(--ink-2); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--bg); border-color: var(--ink-3); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-full { width: 100%; }

        .res-box {
            display: none; margin-top: 14px; padding: 14px 16px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            font-size: 12px; line-height: 1.7; white-space: pre-wrap;
            word-break: break-all; max-height: 180px; overflow-y: auto;
            border: 1px solid transparent;
        }
        .res-box.show { display: block; animation: fadeIn 0.2s ease; }
        .res-box.ok { background: var(--green-bg); color: var(--green); border-color: #c8e6d4; }
        .res-box.err { background: var(--red-bg); color: var(--red); border-color: #f5c6c2; }

        .accounts-wrap { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 4px; }

        .acc-card {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px;
            transition: all 0.15s; animation: fadeIn 0.25s ease; cursor: default;
        }
        .acc-card:hover { border-color: var(--ink-3); box-shadow: 0 4px 16px rgba(0,0,0,0.06); transform: translateY(-2px); }
        .acc-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--ink); color: var(--white); display: flex; align-items: center; justify-content: center; font-family: var(--serif); font-size: 18px; margin-bottom: 16px; }
        .acc-id { font-size: 11px; color: var(--ink-3); margin-bottom: 4px; }
        .acc-owner { font-size: 15px; font-weight: 500; color: var(--ink); margin-bottom: 12px; }
        .acc-balance { font-family: var(--serif); font-size: 26px; color: var(--ink); letter-spacing: -0.5px; line-height: 1; margin-bottom: 4px; }
        .acc-currency { font-size: 11px; color: var(--ink-3); letter-spacing: 0.5px; }

        .preview { display: none; background: var(--green-bg); border: 1px solid #c8e6d4; border-radius: 8px; padding: 16px; margin: 16px 0 0; }
        .preview.show { display: block; animation: fadeIn 0.2s ease; }
        .preview-row { display: flex; justify-content: space-between; font-size: 13px; padding: 5px 0; border-bottom: 1px solid #c8e6d440; }
        .preview-row:last-child { border-bottom: none; }
        .preview-key { color: var(--green); }
        .preview-val { font-weight: 500; color: var(--green); }

        .divider { height: 1px; background: var(--border); margin: 28px 0; }

        .tx-list { display: flex; flex-direction: column; gap: 8px; }
        .tx-item { display: flex; align-items: center; gap: 14px; padding: 16px 20px; background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); transition: border-color 0.15s; animation: fadeIn 0.2s ease; }
        .tx-item:hover { border-color: var(--ink-3); }
        .tx-pip { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .tx-pip.COMPLETED { background: var(--green); }
        .tx-pip.FAILED { background: var(--red); }
        .tx-pip.PENDING { background: var(--blue); }
        .tx-body { flex: 1; }
        .tx-title { font-size: 14px; font-weight: 500; color: var(--ink); margin-bottom: 3px; }
        .tx-meta { font-size: 12px; color: var(--ink-3); line-height: 1.4; }
        .tx-right { text-align: right; }
        .tx-amount { font-family: var(--serif); font-size: 18px; letter-spacing: -0.3px; }
        .tx-amount.out { color: var(--red); }
        .tx-amount.in { color: var(--green); }
        .tx-badge { display: inline-block; font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; padding: 2px 8px; border-radius: 100px; margin-top: 4px; }
        .tx-badge.COMPLETED { background: var(--green-bg); color: var(--green); }
        .tx-badge.FAILED { background: var(--red-bg); color: var(--red); }
        .tx-badge.PENDING { background: var(--blue-bg); color: var(--blue); }

        .steps { display: flex; flex-direction: column; }
        .step { display: flex; gap: 20px; padding: 20px 0; border-bottom: 1px solid var(--border); }
        .step:last-child { border-bottom: none; }
        .step-num { font-family: var(--serif); font-size: 28px; color: var(--ink-4); line-height: 1; width: 32px; flex-shrink: 0; padding-top: 2px; }
        .step-title { font-size: 14px; font-weight: 600; color: var(--ink); margin-bottom: 4px; }
        .step-desc { font-size: 13px; color: var(--ink-3); line-height: 1.6; }

        .empty { text-align: center; padding: 48px 24px; color: var(--ink-3); }
        .empty-icon { font-family: var(--serif); font-size: 48px; color: var(--ink-4); display: block; margin-bottom: 12px; }
        .empty-text { font-size: 14px; }

        .toast { position: fixed; bottom: 28px; right: 28px; padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 500; z-index: 9999; opacity: 0; transform: translateY(12px); transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; max-width: 300px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.ok { background: var(--ink); color: var(--white); }
        .toast.err { background: var(--red); color: var(--white); }

        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; margin-right: 6px; }

        @media (max-width: 768px) {
            .layout { grid-template-columns: 1fr; }
            aside { display: none; }
            main { padding: 28px 20px; }
            header { padding: 0 20px; }
            .field-row { grid-template-columns: 1fr; }
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <div>
        <span class="logo-serif">FX Transfer</span>
        <span class="logo-dot"></span>
    </div>
    <div class="api-badge">
        <div class="api-dot" id="api-dot"></div>
        <span id="api-status">Connecting</span>
    </div>
</header>

<div class="layout">
    <aside>
        <div class="nav-section">
            <div class="nav-label">Menu</div>
            <button class="nav-item active" onclick="nav('accounts',this)">
                <span class="nav-icon">◈</span> Accounts
            </button>
            <button class="nav-item" onclick="nav('transfer',this)">
                <span class="nav-icon">→</span> Transfer
            </button>
            <button class="nav-item" onclick="nav('history',this)">
                <span class="nav-icon">≡</span> History
            </button>
        </div>
        <hr>
        <div class="sidebar-stat">
            <div class="sidebar-stat-label">Total accounts</div>
            <div class="sidebar-stat-value" id="stat-accounts">—</div>
        </div>
        <div class="sidebar-stat">
            <div class="sidebar-stat-label">Currencies</div>
            <div class="sidebar-stat-value">6</div>
        </div>
    </aside>

    <main>

        <!-- ACCOUNTS -->
        <div class="panel active" id="panel-accounts">
            <div class="page-header">
                <div class="page-title">Accounts</div>
                <div class="page-sub">Create and manage currency accounts</div>
            </div>

            <div class="card">
                <div class="card-title">New Account</div>
                <div class="field-row">
                    <div class="field">
                        <label>Owner name</label>
                        <input id="ac-owner" type="text" placeholder="e.g. Bhavesh">
                    </div>
                    <div class="field">
                        <label>Currency</label>
                        <select id="ac-currency">
                            <option value="EUR">EUR — Euro</option>
                            <option value="USD">USD — US Dollar</option>
                            <option value="GBP">GBP — British Pound</option>
                            <option value="INR">INR — Indian Rupee</option>
                            <option value="SEK">SEK — Swedish Krona</option>
                            <option value="NOK">NOK — Norwegian Krone</option>
                        </select>
                    </div>
                </div>
                <div class="field">
                    <label>Initial balance</label>
                    <input id="ac-balance" type="number" placeholder="1000.00" min="0" step="0.01">
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="btn-create" onclick="createAccount()">Create Account</button>
                </div>
                <div class="res-box" id="res-create"></div>
            </div>

            <div class="card">
                <div class="card-title">Deposit / Withdraw</div>
                <div class="field-row">
                    <div class="field">
                        <label>Account ID</label>
                        <input id="qa-id" type="number" placeholder="1" min="1">
                    </div>
                    <div class="field">
                        <label>Amount</label>
                        <input id="qa-amount" type="number" placeholder="100.00" min="0.01" step="0.01">
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="deposit()">Deposit</button>
                    <button class="btn btn-ghost" onclick="withdraw()">Withdraw</button>
                </div>
                <div class="res-box" id="res-qa"></div>
            </div>

            <div class="divider"></div>

            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:13px;color:var(--ink-2);font-weight:500;">All accounts</div>
                <button class="btn btn-ghost" onclick="loadAccounts()" style="padding:6px 14px;font-size:12px;">Refresh</button>
            </div>
            <div id="accounts-wrap" class="accounts-wrap">
                <div class="empty"><span class="empty-icon">◎</span><div class="empty-text">No accounts yet</div></div>
            </div>
        </div>

        <!-- TRANSFER -->
        <div class="panel" id="panel-transfer">
            <div class="page-header">
                <div class="page-title">Send a <em>Transfer</em></div>
                <div class="page-sub">Live exchange rates · Fee calculated at submission</div>
            </div>

            <div class="card">
                <div class="card-title">Transfer Details</div>
                <div class="field-row">
                    <div class="field">
                        <label>From account ID</label>
                        <input id="tr-from" type="number" placeholder="1" min="1" oninput="calcPreview()">
                    </div>
                    <div class="field">
                        <label>To account ID</label>
                        <input id="tr-to" type="number" placeholder="2" min="1">
                    </div>
                </div>
                <div class="field">
                    <label>Amount</label>
                    <input id="tr-amount" type="number" placeholder="100.00" min="0.01" step="0.01" oninput="calcPreview()">
                </div>
                <div class="field">
                    <label>Idempotency key <span style="color:var(--ink-4);font-weight:400">(auto-generated)</span></label>
                    <input id="tr-key" type="text" readonly>
                </div>
                <div class="preview" id="preview">
                    <div class="preview-row">
                        <span class="preview-key">Transfer amount</span>
                        <span class="preview-val" id="prev-amount">—</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-key">Fee (0.50 + 0.5%)</span>
                        <span class="preview-val" id="prev-fee">—</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-key">Total deducted</span>
                        <span class="preview-val" id="prev-total">—</span>
                    </div>
                </div>
                <div class="btn-row" style="margin-top:16px;">
                    <button class="btn btn-primary btn-full" id="btn-transfer" onclick="doTransfer()">Send Transfer</button>
                </div>
                <div class="res-box" id="res-transfer"></div>
            </div>

            <div class="card">
                <div class="card-title">How it works</div>
                <div class="steps">
                    <div class="step">
                        <div class="step-num">1</div>
                        <div><div class="step-title">Live exchange rates</div><div class="step-desc">Every transfer fetches a real-time rate from ExchangeRate-API. No hardcoded values.</div></div>
                    </div>
                    <div class="step">
                        <div class="step-num">2</div>
                        <div><div class="step-title">Fee calculation</div><div class="step-desc">Flat 0.50 + 0.5% of amount, deducted from the sender's balance on top of the transfer amount.</div></div>
                    </div>
                    <div class="step">
                        <div class="step-num">3</div>
                        <div><div class="step-title">Idempotency protection</div><div class="step-desc">Each transfer carries a unique key. Send the same request twice — you get the same result, no double charge.</div></div>
                    </div>
                    <div class="step">
                        <div class="step-num">4</div>
                        <div><div class="step-title">Transactional safety</div><div class="step-desc">The entire transfer runs inside a @Transactional block. If anything fails mid-way, everything rolls back.</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY -->
        <div class="panel" id="panel-history">
            <div class="page-header">
                <div class="page-title">Transaction <em>History</em></div>
                <div class="page-sub">Full audit trail for any account</div>
            </div>
            <div class="card" style="margin-bottom:24px;">
                <div style="display:flex;gap:12px;align-items:flex-end;">
                    <div class="field" style="flex:1;margin:0;">
                        <label>Account ID</label>
                        <input id="hist-id" type="number" placeholder="1" min="1">
                    </div>
                    <button class="btn btn-primary" onclick="loadHistory()">Load History</button>
                </div>
            </div>
            <div id="tx-list"></div>
        </div>

    </main>
</div>

<div class="toast" id="toast"></div>

<script>
    const API = 'http://localhost:8080/api';

    async function req(path, opts={}) {
        const r = await fetch(API+path, { headers:{'Content-Type':'application/json'}, ...opts });
        const d = await r.json();
        if (!r.ok) throw d;
        return d;
    }

    function fmt(n) { return new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n); }
    function fmtDate(iso) { return new Date(iso).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
    function genKey() { return 'tx-'+Math.random().toString(36).slice(2,9)+'-'+Date.now().toString(36); }

    function toast(msg, type='ok') {
        const t = document.getElementById('toast');
        t.textContent = msg; t.className = `toast ${type} show`;
        setTimeout(()=>t.className='toast', 3000);
    }

    function showRes(id, data, isErr) {
        const el = document.getElementById(id);
        el.textContent = JSON.stringify(data,null,2);
        el.className = `res-box show ${isErr?'err':'ok'}`;
    }

    function setBtn(id, loading, label) {
        const b = document.getElementById(id);
        if (loading) { b.disabled=true; b._o=b.innerHTML; b.innerHTML=`<span class="spinner"></span>${label}`; }
        else { b.disabled=false; b.innerHTML=b._o; }
    }

    function nav(name, el) {
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+name).classList.add('active');
        if (name==='accounts') loadAccounts();
        if (name==='transfer') document.getElementById('tr-key').value=genKey();
    }

    async function loadAccounts() {
        try {
            const list = await req('/accounts');
            document.getElementById('stat-accounts').textContent = list.length;
            const wrap = document.getElementById('accounts-wrap');
            if (!list.length) {
                wrap.innerHTML=`<div class="empty"><span class="empty-icon">◎</span><div class="empty-text">No accounts yet.<br>Create one above.</div></div>`;
                return;
            }
            wrap.innerHTML = list.map(a=>`
      <div class="acc-card">
        <div class="acc-avatar">${a.owner[0].toUpperCase()}</div>
        <div class="acc-id">Account #${a.id}</div>
        <div class="acc-owner">${a.owner}</div>
        <div class="acc-balance">${fmt(a.balance)}</div>
        <div class="acc-currency">${a.currency}</div>
      </div>`).join('');
        } catch(e) { console.error(e); }
    }

    async function createAccount() {
        const owner = document.getElementById('ac-owner').value.trim();
        const bal   = parseFloat(document.getElementById('ac-balance').value);
        const cur   = document.getElementById('ac-currency').value;
        if (!owner) return toast('Owner name required','err');
        if (isNaN(bal)||bal<0) return toast('Enter a valid balance','err');
        setBtn('btn-create',true,'Creating...');
        try {
            const data = await req('/accounts',{method:'POST',body:JSON.stringify({owner,initialBalance:bal,currency:cur})});
            showRes('res-create',data,false);
            toast(`Account created for ${data.owner}`);
            document.getElementById('ac-owner').value='';
            document.getElementById('ac-balance').value='';
            loadAccounts();
        } catch(e) { showRes('res-create',e,true); toast(e.message||'Error','err'); }
        finally { setBtn('btn-create',false); }
    }

    async function deposit() {
        const id=document.getElementById('qa-id').value;
        const amt=parseFloat(document.getElementById('qa-amount').value);
        if (!id) return toast('Enter an account ID','err');
        if (!amt||amt<=0) return toast('Enter a valid amount','err');
        try {
            const data=await req(`/accounts/${id}/deposit`,{method:'POST',body:JSON.stringify({amount:amt})});
            showRes('res-qa',data,false); toast(`Deposited ${fmt(amt)}`); loadAccounts();
        } catch(e) { showRes('res-qa',e,true); toast(e.message||'Failed','err'); }
    }

    async function withdraw() {
        const id=document.getElementById('qa-id').value;
        const amt=parseFloat(document.getElementById('qa-amount').value);
        if (!id) return toast('Enter an account ID','err');
        if (!amt||amt<=0) return toast('Enter a valid amount','err');
        try {
            const data=await req(`/accounts/${id}/withdraw`,{method:'POST',body:JSON.stringify({amount:amt})});
            showRes('res-qa',data,false); toast(`Withdrawn ${fmt(amt)}`); loadAccounts();
        } catch(e) { showRes('res-qa',e,true); toast(e.message||'Failed','err'); }
    }

    function calcPreview() {
        const amt=parseFloat(document.getElementById('tr-amount').value);
        const prev=document.getElementById('preview');
        if (!amt||amt<=0) { prev.classList.remove('show'); return; }
        const fee=Math.round((0.50+amt*0.005)*100)/100;
        const total=Math.round((amt+fee)*100)/100;
        document.getElementById('prev-amount').textContent=fmt(amt);
        document.getElementById('prev-fee').textContent=fmt(fee);
        document.getElementById('prev-total').textContent=fmt(total);
        prev.classList.add('show');
    }

    async function doTransfer() {
        const from=parseInt(document.getElementById('tr-from').value);
        const to=parseInt(document.getElementById('tr-to').value);
        const amt=parseFloat(document.getElementById('tr-amount').value);
        const key=document.getElementById('tr-key').value;
        if (!from||!to) return toast('Enter both account IDs','err');
        if (from===to) return toast('Cannot transfer to same account','err');
        if (!amt||amt<=0) return toast('Enter a valid amount','err');
        setBtn('btn-transfer',true,'Sending...');
        try {
            const data=await req('/transfers',{method:'POST',body:JSON.stringify({fromAccountId:from,toAccountId:to,amount:amt,idempotencyKey:key})});
            showRes('res-transfer',data,false);
            toast(`Transfer ${data.status.toLowerCase()}`);
            document.getElementById('tr-key').value=genKey();
            loadAccounts();
        } catch(e) { showRes('res-transfer',e,true); toast(e.message||'Transfer failed','err'); }
        finally { setBtn('btn-transfer',false); }
    }

    async function loadHistory() {
        const id=document.getElementById('hist-id').value;
        if (!id) return toast('Enter an account ID','err');
        const container=document.getElementById('tx-list');
        container.innerHTML=`<div class="empty"><span class="empty-icon" style="animation:spin 1s linear infinite;display:inline-block">◎</span><div class="empty-text" style="margin-top:12px">Loading...</div></div>`;
        try {
            const txs=await req(`/transfers/history/${id}`);
            if (!txs.length) {
                container.innerHTML=`<div class="empty"><span class="empty-icon">◎</span><div class="empty-text">No transactions for account #${id}</div></div>`;
                return;
            }
            container.innerHTML=`<div class="tx-list">${txs.map(tx=>{
                const isSender=tx.fromAccountId==id;
                const amtClass=(tx.status==='COMPLETED'&&isSender)?'out':'in';
                return `<div class="tx-item">
        <div class="tx-pip ${tx.status}"></div>
        <div class="tx-body">
          <div class="tx-title">${isSender?`Sent to account #${tx.toAccountId}`:`Received from account #${tx.fromAccountId}`}</div>
          <div class="tx-meta">Rate: 1 ${tx.fromCurrency} = ${tx.exchangeRate.toFixed(4)} ${tx.toCurrency} &nbsp;·&nbsp; Fee: ${fmt(tx.fee)} &nbsp;·&nbsp; ${fmtDate(tx.createdAt)}
          ${tx.failureReason?`<br><span style="color:var(--red)">${tx.failureReason}</span>`:''}</div>
        </div>
        <div class="tx-right">
          <div class="tx-amount ${amtClass}">${isSender?'−':'+'}${fmt(tx.amount)}</div>
          <span class="tx-badge ${tx.status}">${tx.status}</span>
        </div>
      </div>`;
            }).join('')}</div>`;
        } catch(e) {
            container.innerHTML=`<div class="empty"><span class="empty-icon">✕</span><div class="empty-text">${e.message||'Could not load history'}</div></div>`;
            toast(e.message||'Error','err');
        }
    }

    async function checkApi() {
        const dot=document.getElementById('api-dot');
        const status=document.getElementById('api-status');
        try { await req('/accounts'); dot.className='api-dot live'; status.textContent='API connected'; }
        catch { dot.className='api-dot dead'; status.textContent='API offline'; }
    }

    document.getElementById('tr-key').value=genKey();
    checkApi();
    loadAccounts();
</script>
</body>
</html>